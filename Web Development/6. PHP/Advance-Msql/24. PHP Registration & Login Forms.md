## Table of Contents

1. [Database Setup](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#database-setup)
2. [Registration Forms](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#registration-forms)
3. [Login Forms](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#login-forms)
4. [Password Security](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#password-security)
5. [Form Validation](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#form-validation)
6. [Security Best Practices](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#security-best-practices)
7. [Complete Examples](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#complete-examples)
8. [Advanced Features](https://claude.ai/chat/4dff46c4-de29-4820-98b1-1a4946d379b6#advanced-features)

## Database Setup

### Basic Users Table Structure

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    email_verified BOOLEAN DEFAULT FALSE,
    last_login TIMESTAMP NULL,
    failed_login_attempts INT DEFAULT 0,
    locked_until TIMESTAMP NULL
);
```

### Enhanced Users Table with Security Features

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    phone VARCHAR(20),
    date_of_birth DATE,
    profile_image VARCHAR(255),
    
    -- Security fields
    email_verification_token VARCHAR(255),
    email_verified_at TIMESTAMP NULL,
    password_reset_token VARCHAR(255),
    password_reset_expires TIMESTAMP NULL,
    
    -- Account status
    is_active BOOLEAN DEFAULT TRUE,
    account_locked BOOLEAN DEFAULT FALSE,
    failed_login_attempts INT DEFAULT 0,
    locked_until TIMESTAMP NULL,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    
    -- Indexes
    INDEX idx_email (email),
    INDEX idx_username (username),
    INDEX idx_email_verification_token (email_verification_token),
    INDEX idx_password_reset_token (password_reset_token)
);
```

## Registration Forms

### Basic Registration HTML Form

```html
<!DOCTYPE html>
<html>
<head>
    <title>User Registration</title>
    <style>
        .form-container { max-width: 400px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .error { color: red; font-size: 14px; }
        .success { color: green; font-size: 14px; }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Create Account</h2>
        <form method="POST" action="register.php">
            <div class="form-group">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name" required>
            </div>
            
            <div class="form-group">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name" required>
            </div>
            
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            
            <div class="form-group">
                <label for="confirm_password">Confirm Password:</label>
                <input type="password" id="confirm_password" name="confirm_password" required>
            </div>
            
            <button type="submit" name="register" class="btn">Register</button>
        </form>
        
        <p>Already have an account? <a href="login.php">Login here</a></p>
    </div>
</body>
</html>
```

### Registration Processing (register.php)

```php
<?php
session_start();
require_once 'config.php'; // Database configuration

$errors = [];
$success = '';

if ($_POST['register']) {
    // Get form data
    $first_name = trim($_POST['first_name']);
    $last_name = trim($_POST['last_name']);
    $username = trim($_POST['username']);
    $email = trim($_POST['email']);
    $password = $_POST['password'];
    $confirm_password = $_POST['confirm_password'];
    
    // Validation
    if (empty($first_name)) {
        $errors[] = "First name is required";
    }
    
    if (empty($last_name)) {
        $errors[] = "Last name is required";
    }
    
    if (empty($username)) {
        $errors[] = "Username is required";
    } elseif (strlen($username) < 3) {
        $errors[] = "Username must be at least 3 characters";
    } elseif (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {
        $errors[] = "Username can only contain letters, numbers, and underscores";
    }
    
    if (empty($email)) {
        $errors[] = "Email is required";
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errors[] = "Please enter a valid email address";
    }
    
    if (empty($password)) {
        $errors[] = "Password is required";
    } elseif (strlen($password) < 8) {
        $errors[] = "Password must be at least 8 characters long";
    } elseif (!preg_match('/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/', $password)) {
        $errors[] = "Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character";
    }
    
    if ($password !== $confirm_password) {
        $errors[] = "Passwords do not match";
    }
    
    // Check if username or email already exists
    if (empty($errors)) {
        try {
            $stmt = $pdo->prepare("SELECT id FROM users WHERE username = ? OR email = ?");
            $stmt->execute([$username, $email]);
            
            if ($stmt->fetch()) {
                $errors[] = "Username or email already exists";
            }
        } catch (PDOException $e) {
            $errors[] = "Database error occurred";
            error_log("Registration error: " . $e->getMessage());
        }
    }
    
    // If no errors, create user
    if (empty($errors)) {
        try {
            $hashed_password = password_hash($password, PASSWORD_DEFAULT);
            $email_verification_token = bin2hex(random_bytes(32));
            
            $stmt = $pdo->prepare("
                INSERT INTO users (first_name, last_name, username, email, password, email_verification_token) 
                VALUES (?, ?, ?, ?, ?, ?)
            ");
            
            $stmt->execute([
                $first_name,
                $last_name,
                $username,
                $email,
                $hashed_password,
                $email_verification_token
            ]);
            
            // Send verification email (implement your email function)
            // send_verification_email($email, $email_verification_token);
            
            $success = "Registration successful! Please check your email to verify your account.";
            
            // Clear form data on success
            $first_name = $last_name = $username = $email = '';
            
        } catch (PDOException $e) {
            $errors[] = "Registration failed. Please try again.";
            error_log("Registration error: " . $e->getMessage());
        }
    }
}
?>
```

## Login Forms

### Basic Login HTML Form

```html
<!DOCTYPE html>
<html>
<head>
    <title>User Login</title>
    <style>
        .form-container { max-width: 400px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .error { color: red; font-size: 14px; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Login</h2>
        <form method="POST" action="login.php">
            <div class="form-group">
                <label for="login_identifier">Username or Email:</label>
                <input type="text" id="login_identifier" name="login_identifier" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="remember_me" name="remember_me">
                <label for="remember_me">Remember me</label>
            </div>
            
            <button type="submit" name="login" class="btn">Login</button>
        </form>
        
        <p><a href="forgot_password.php">Forgot your password?</a></p>
        <p>Don't have an account? <a href="register.php">Register here</a></p>
    </div>
</body>
</html>
```

### Login Processing (login.php)

```php
<?php
session_start();
require_once 'config.php';

$errors = [];

// Redirect if already logged in
if (isset($_SESSION['user_id'])) {
    header('Location: dashboard.php');
    exit();
}

if ($_POST['login']) {
    $login_identifier = trim($_POST['login_identifier']);
    $password = $_POST['password'];
    $remember_me = isset($_POST['remember_me']);
    
    // Basic validation
    if (empty($login_identifier)) {
        $errors[] = "Username or email is required";
    }
    
    if (empty($password)) {
        $errors[] = "Password is required";
    }
    
    if (empty($errors)) {
        try {
            // Check if user exists and get user data
            $stmt = $pdo->prepare("
                SELECT id, username, email, password, first_name, last_name, 
                       is_active, email_verified, failed_login_attempts, 
                       locked_until, account_locked 
                FROM users 
                WHERE (username = ? OR email = ?) AND is_active = 1
            ");
            $stmt->execute([$login_identifier, $login_identifier]);
            $user = $stmt->fetch(PDO::FETCH_ASSOC);
            
            if ($user) {
                // Check if account is locked
                if ($user['account_locked'] || 
                    ($user['locked_until'] && new DateTime() < new DateTime($user['locked_until']))) {
                    $errors[] = "Account is temporarily locked due to multiple failed login attempts";
                } 
                // Check if email is verified (optional)
                elseif (!$user['email_verified']) {
                    $errors[] = "Please verify your email address before logging in";
                }
                // Verify password
                elseif (password_verify($password, $user['password'])) {
                    // Successful login
                    
                    // Reset failed login attempts
                    $stmt = $pdo->prepare("
                        UPDATE users 
                        SET failed_login_attempts = 0, locked_until = NULL, last_login = NOW() 
                        WHERE id = ?
                    ");
                    $stmt->execute([$user['id']]);
                    
                    // Regenerate session ID for security
                    session_regenerate_id(true);
                    
                    // Set session variables
                    $_SESSION['user_id'] = $user['id'];
                    $_SESSION['username'] = $user['username'];
                    $_SESSION['email'] = $user['email'];
                    $_SESSION['first_name'] = $user['first_name'];
                    $_SESSION['last_name'] = $user['last_name'];
                    $_SESSION['logged_in'] = true;
                    $_SESSION['login_time'] = time();
                    
                    // Handle "Remember Me" functionality
                    if ($remember_me) {
                        $token = bin2hex(random_bytes(32));
                        $expires = date('Y-m-d H:i:s', time() + (30 * 24 * 60 * 60)); // 30 days
                        
                        // Store remember token in database (you'll need a remember_tokens table)
                        // setcookie('remember_token', $token, time() + (30 * 24 * 60 * 60), '/', '', true, true);
                    }
                    
                    // Redirect to dashboard or intended page
                    $redirect = $_SESSION['redirect_after_login'] ?? 'dashboard.php';
                    unset($_SESSION['redirect_after_login']);
                    
                    header('Location: ' . $redirect);
                    exit();
                    
                } else {
                    // Failed login - increment failed attempts
                    $failed_attempts = $user['failed_login_attempts'] + 1;
                    $lock_until = null;
                    
                    // Lock account after 5 failed attempts for 15 minutes
                    if ($failed_attempts >= 5) {
                        $lock_until = date('Y-m-d H:i:s', time() + (15 * 60));
                    }
                    
                    $stmt = $pdo->prepare("
                        UPDATE users 
                        SET failed_login_attempts = ?, locked_until = ? 
                        WHERE id = ?
                    ");
                    $stmt->execute([$failed_attempts, $lock_until, $user['id']]);
                    
                    $errors[] = "Invalid username/email or password";
                }
            } else {
                $errors[] = "Invalid username/email or password";
            }
            
        } catch (PDOException $e) {
            $errors[] = "Login failed. Please try again.";
            error_log("Login error: " . $e->getMessage());
        }
    }
}
?>
```

## Password Security

### Password Hashing Best Practices

```php
// Hashing passwords (registration)
$password = $_POST['password'];
$hashed_password = password_hash($password, PASSWORD_DEFAULT);

// Alternative with custom options
$options = [
    'cost' => 12, // Increase for better security (slower hashing)
];
$hashed_password = password_hash($password, PASSWORD_DEFAULT, $options);

// Verifying passwords (login)
$password = $_POST['password'];
$stored_hash = $user['password']; // From database

if (password_verify($password, $stored_hash)) {
    // Password is correct
    
    // Check if password needs rehashing (if you updated your hashing parameters)
    if (password_needs_rehash($stored_hash, PASSWORD_DEFAULT)) {
        $new_hash = password_hash($password, PASSWORD_DEFAULT);
        // Update database with new hash
        $stmt = $pdo->prepare("UPDATE users SET password = ? WHERE id = ?");
        $stmt->execute([$new_hash, $user['id']]);
    }
} else {
    // Password is incorrect
}
```

### Password Strength Requirements

```php
function validate_password($password) {
    $errors = [];
    
    if (strlen($password) < 8) {
        $errors[] = "Password must be at least 8 characters long";
    }
    
    if (strlen($password) > 128) {
        $errors[] = "Password must be less than 128 characters";
    }
    
    if (!preg_match('/[a-z]/', $password)) {
        $errors[] = "Password must contain at least one lowercase letter";
    }
    
    if (!preg_match('/[A-Z]/', $password)) {
        $errors[] = "Password must contain at least one uppercase letter";
    }
    
    if (!preg_match('/\d/', $password)) {
        $errors[] = "Password must contain at least one number";
    }
    
    if (!preg_match('/[@$!%*?&]/', $password)) {
        $errors[] = "Password must contain at least one special character (@$!%*?&)";
    }
    
    // Check against common passwords
    $common_passwords = ['password', '123456', 'password123', 'admin', 'qwerty'];
    if (in_array(strtolower($password), $common_passwords)) {
        $errors[] = "Please choose a less common password";
    }
    
    return $errors;
}
```

## Form Validation

### Server-Side Validation Functions

```php
class FormValidator {
    
    public static function validate_username($username) {
        $errors = [];
        
        if (empty($username)) {
            $errors[] = "Username is required";
        } elseif (strlen($username) < 3) {
            $errors[] = "Username must be at least 3 characters";
        } elseif (strlen($username) > 50) {
            $errors[] = "Username must be less than 50 characters";
        } elseif (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {
            $errors[] = "Username can only contain letters, numbers, and underscores";
        }
        
        return $errors;
    }
    
    public static function validate_email($email) {
        $errors = [];
        
        if (empty($email)) {
            $errors[] = "Email is required";
        } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $errors[] = "Please enter a valid email address";
        } elseif (strlen($email) > 100) {
            $errors[] = "Email must be less than 100 characters";
        }
        
        return $errors;
    }
    
    public static function validate_name($name, $field_name) {
        $errors = [];
        
        if (empty($name)) {
            $errors[] = "$field_name is required";
        } elseif (strlen($name) < 2) {
            $errors[] = "$field_name must be at least 2 characters";
        } elseif (strlen($name) > 50) {
            $errors[] = "$field_name must be less than 50 characters";
        } elseif (!preg_match('/^[a-zA-Z\s\'-]+$/', $name)) {
            $errors[] = "$field_name can only contain letters, spaces, hyphens, and apostrophes";
        }
        
        return $errors;
    }
    
    public static function sanitize_input($input) {
        return htmlspecialchars(trim($input), ENT_QUOTES, 'UTF-8');
    }
}
```

### Client-Side Validation (JavaScript)

```html
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');
    
    // Real-time password strength indicator
    password.addEventListener('input', function() {
        const strength = checkPasswordStrength(this.value);
        updatePasswordStrengthIndicator(strength);
    });
    
    // Password confirmation validation
    confirmPassword.addEventListener('input', function() {
        if (this.value !== password.value) {
            this.setCustomValidity('Passwords do not match');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
    
    function checkPasswordStrength(password) {
        let strength = 0;
        const checks = [
            /.{8,}/, // At least 8 characters
            /[a-z]/, // Lowercase
            /[A-Z]/, // Uppercase
            /\d/,    // Number
            /[@$!%*?&]/ // Special character
        ];
        
        checks.forEach(check => {
            if (check.test(password)) strength++;
        });
        
        return strength;
    }
    
    function updatePasswordStrengthIndicator(strength) {
        const indicator = document.getElementById('password-strength');
        if (!indicator) return;
        
        const levels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
        const colors = ['#ff4444', '#ff8800', '#ffbb00', '#88cc00', '#00cc00'];
        
        indicator.textContent = levels[strength] || 'Very Weak';
        indicator.style.color = colors[strength] || '#ff4444';
    }
    
    function validateForm() {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.style.borderColor = 'red';
            } else {
                field.style.borderColor = '#ddd';
            }
        });
        
        return isValid;
    }
});
</script>
```

## Security Best Practices

### CSRF Protection

```php
// Generate CSRF token
function generate_csrf_token() {
    if (!isset($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

// Validate CSRF token
function validate_csrf_token($token) {
    return isset($_SESSION['csrf_token']) && hash_equals($_SESSION['csrf_token'], $token);
}

// In your forms, add:
echo '<input type="hidden" name="csrf_token" value="' . generate_csrf_token() . '">';

// In form processing:
if (!validate_csrf_token($_POST['csrf_token'])) {
    die('CSRF token validation failed');
}
```

### Rate Limiting

```php
class RateLimiter {
    private static function get_client_ip() {
        $ip_keys = ['HTTP_CLIENT_IP', 'HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR'];
        foreach ($ip_keys as $key) {
            if (array_key_exists($key, $_SERVER) && !empty($_SERVER[$key])) {
                $ip = explode(',', $_SERVER[$key])[0];
                if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) {
                    return $ip;
                }
            }
        }
        return $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';
    }
    
    public static function check_rate_limit($action, $max_attempts = 5, $time_window = 300) {
        $ip = self::get_client_ip();
        $key = $action . '_' . $ip;
        
        if (!isset($_SESSION['rate_limit'])) {
            $_SESSION['rate_limit'] = [];
        }
        
        $current_time = time();
        
        // Clean old entries
        if (isset($_SESSION['rate_limit'][$key])) {
            $_SESSION['rate_limit'][$key] = array_filter(
                $_SESSION['rate_limit'][$key],
                function($timestamp) use ($current_time, $time_window) {
                    return ($current_time - $timestamp) < $time_window;
                }
            );
        } else {
            $_SESSION['rate_limit'][$key] = [];
        }
        
        // Check if limit exceeded
        if (count($_SESSION['rate_limit'][$key]) >= $max_attempts) {
            return false;
        }
        
        // Add current attempt
        $_SESSION['rate_limit'][$key][] = $current_time;
        return true;
    }
}

// Usage in login/registration:
if (!RateLimiter::check_rate_limit('login', 5, 300)) {
    $errors[] = "Too many login attempts. Please try again later.";
}
```

### Input Sanitization and Validation

```php
class InputSanitizer {
    public static function sanitize_string($input, $max_length = null) {
        $sanitized = filter_var($input, FILTER_SANITIZE_STRING);
        $sanitized = trim($sanitized);
        
        if ($max_length && strlen($sanitized) > $max_length) {
            $sanitized = substr($sanitized, 0, $max_length);
        }
        
        return $sanitized;
    }
    
    public static function sanitize_email($email) {
        return filter_var($email, FILTER_SANITIZE_EMAIL);
    }
    
    public static function escape_html($input) {
        return htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
    }
    
    public static function remove_xss($input) {
        // Remove potential XSS vectors
        $input = preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/mi', '', $input);
        $input = preg_replace('/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/mi', '', $input);
        $input = preg_replace('/javascript:/i', '', $input);
        $input = preg_replace('/on\w+\s*=/i', '', $input);
        
        return $input;
    }
}
```

## Complete Examples

### Database Configuration (config.php)

```php
<?php
$host = 'localhost';
$dbname = 'your_database';
$username = 'your_username';
$password = 'your_password';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8mb4", $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ]);
} catch (PDOException $e) {
    error_log("Database connection failed: " . $e->getMessage());
    die("Database connection failed");
}

// Session configuration
ini_set('session.cookie_httponly', 1);
ini_set('session.cookie_secure', 1);
ini_set('session.use_strict_mode', 1);

session_start();
?>
```

### Authentication Helper Functions (auth.php)

```php
<?php
require_once 'config.php';

function is_logged_in() {
    return isset($_SESSION['user_id']) && isset($_SESSION['logged_in']) && $_SESSION['logged_in'] === true;
}

function require_login() {
    if (!is_logged_in()) {
        $_SESSION['redirect_after_login'] = $_SERVER['REQUEST_URI'];
        header('Location: login.php');
        exit();
    }
}

function logout_user() {
    session_start();
    
    // Clear all session variables
    $_SESSION = [];
    
    // Delete session cookie
    if (ini_get("session.use_cookies")) {
        $params = session_get_cookie_params();
        setcookie(session_name(), '', time() - 42000,
            $params["path"], $params["domain"],
            $params["secure"], $params["httponly"]
        );
    }
    
    // Destroy session
    session_destroy();
}

function get_current_user() {
    global $pdo;
    
    if (!is_logged_in()) {
        return null;
    }
    
    try {
        $stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
        $stmt->execute([$_SESSION['user_id']]);
        return $stmt->fetch();
    } catch (PDOException $e) {
        error_log("Error fetching user: " . $e->getMessage());
        return null;
    }
}

function update_last_activity() {
    global $pdo;
    
    if (is_logged_in()) {
        try {
            $stmt = $pdo->prepare("UPDATE users SET last_login = NOW() WHERE id = ?");
            $stmt->execute([$_SESSION['user_id']]);
        } catch (PDOException $e) {
            error_log("Error updating last activity: " . $e->getMessage());
        }
    }
}
?>
```

### Protected Dashboard Example (dashboard.php)

```php
<?php
require_once 'auth.php';
require_login();

$user = get_current_user();
update_last_activity();
?>

<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
</head>
<body>
    <div class="container">
        <header>
            <h1>Welcome, <?php echo htmlspecialchars($user['first_name']); ?>!</h1>
            <nav>
                <a href="profile.php">Profile</a>
                <a href="settings.php">Settings</a>
                <a href="logout.php">Logout</a>
            </nav>
        </header>
        
        <main>
            <div class="user-info">
                <h2>Your Account Information</h2>
                <p><strong>Username:</strong> <?php echo htmlspecialchars($user['username']); ?></p>
                <p><strong>Email:</strong> <?php echo htmlspecialchars($user['email']); ?></p>
                <p><strong>Member since:</strong> <?php echo date('F j, Y', strtotime($user['created_at'])); ?></p>
                <p><strong>Last login:</strong> <?php echo $user['last_login'] ? date('F j, Y g:i A', strtotime($user['last_login'])) : 'Never'; ?></p>
            </div>
        </main>
    </div>
</body>
</html>
```

### Logout Script (logout.php)

```php
<?php
require_once 'auth.php';
logout_user();
header('Location: login.php?message=logged_out');
exit();
?>
```

## Advanced Features

### Email Verification System

#### Email Verification Table

```sql
CREATE TABLE email_verifications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    token VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_token (token),
    INDEX idx_user_id (user_id)
);
```

#### Email Verification Functions

```php
function send_verification_email($email, $token) {
    $verification_link = "https://yoursite.com/verify_email.php?token=" . $token;
    
    $subject = "Verify Your Email Address";
    $message = "
    <html>
    <head>
        <title>Email Verification</title>
    </head>
    <body>
        <h2>Welcome to Our Platform!</h2>
        <p>Please click the link below to verify your email address:</p>
        <p><a href='$verification_link'>Verify Email Address</a></p>
        <p>If you didn't create an account, please ignore this email.</p>
        <p>This link will expire in 24 hours.</p>
    </body>
    </html>
    ";
    
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= 'From: noreply@yoursite.com' . "\r\n";
    
    return mail($email, $subject, $message, $headers);
}

function verify_email_token($token) {
    global $pdo;
    
    try {
        $stmt = $pdo->prepare("
            SELECT user_id FROM email_verifications 
            WHERE token = ? AND expires_at > NOW()
        ");
        $stmt->execute([$token]);
        $verification = $stmt->fetch();
        
        if ($verification) {
            // Mark email as verified
            $stmt = $pdo->prepare("
                UPDATE users 
                SET email_verified = 1, email_verified_at = NOW() 
                WHERE id = ?
            ");
            $stmt->execute([$verification['user_id']]);
            
            // Delete verification token
            $stmt = $pdo->prepare("DELETE FROM email_verifications WHERE token = ?");
            $stmt->execute([$token]);
            
            return true;
        }
        
        return false;
    } catch (PDOException $e) {
        error_log("Email verification error: " . $e->getMessage());
        return false;
    }
}
```

#### Email Verification Page (verify_email.php)

```php
<?php
require_once 'config.php';

$message = '';
$success = false;

if (isset($_GET['token'])) {
    $token = $_GET['token'];
    
    if (verify_email_token($token)) {
        $message = "Email verified successfully! You can now log in.";
        $success = true;
    } else {
        $message = "Invalid or expired verification token.";
    }
} else {
    $message = "No verification token provided.";
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Email Verification</title>
    <style>
        .container { max-width: 500px; margin: 100px auto; padding: 20px; text-align: center; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Email Verification</h2>
        <p class="<?php echo $success ? 'success' : 'error'; ?>">
            <?php echo htmlspecialchars($message); ?>
        </p>
        
        <?php if ($success): ?>
            <a href="login.php">Go to Login</a>
        <?php else: ?>
            <a href="register.php">Back to Registration</a>
        <?php endif; ?>
    </div>
</body>
</html>
```

### Password Reset System

#### Password Reset Functions

```php
function send_password_reset_email($email) {
    global $pdo;
    
    try {
        // Check if user exists
        $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ?");
        $stmt->execute([$email]);
        $user = $stmt->fetch();
        
        if (!$user) {
            return false; // Don't reveal if email exists
        }
        
        // Generate reset token
        $token = bin2hex(random_bytes(32));
        $expires = date('Y-m-d H:i:s', time() + 3600); // 1 hour
        
        // Store reset token
        $stmt = $pdo->prepare("
            UPDATE users 
            SET password_reset_token = ?, password_reset_expires = ? 
            WHERE id = ?
        ");
        $stmt->execute([$token, $expires, $user['id']]);
        
        // Send email
        $reset_link = "https://yoursite.com/reset_password.php?token=" . $token;
        
        $subject = "Password Reset Request";
        $message = "
        <html>
        <head>
            <title>Password Reset</title>
        </head>
        <body>
            <h2>Password Reset Request</h2>
            <p>You requested a password reset. Click the link below to reset your password:</p>
            <p><a href='$reset_link'>Reset Password</a></p>
            <p>If you didn't request this, please ignore this email.</p>
            <p>This link will expire in 1 hour.</p>
        </body>
        </html>
        ";
        
        $headers = "MIME-Version: 1.0" . "\r\n";
        $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
        $headers .= 'From: noreply@yoursite.com' . "\r\n";
        
        return mail($email, $subject, $message, $headers);
        
    } catch (PDOException $e) {
        error_log("Password reset error: " . $e->getMessage());
        return false;
    }
}

function validate_reset_token($token) {
    global $pdo;
    
    try {
        $stmt = $pdo->prepare("
            SELECT id FROM users 
            WHERE password_reset_token = ? AND password_reset_expires > NOW()
        ");
        $stmt->execute([$token]);
        return $stmt->fetch();
    } catch (PDOException $e) {
        error_log("Token validation error: " . $e->getMessage());
        return false;
    }
}

function reset_password($token, $new_password) {
    global $pdo;
    
    $user = validate_reset_token($token);
    if (!$user) {
        return false;
    }
    
    try {
        $hashed_password = password_hash($new_password, PASSWORD_DEFAULT);
        
        $stmt = $pdo->prepare("
            UPDATE users 
            SET password = ?, password_reset_token = NULL, password_reset_expires = NULL 
            WHERE id = ?
        ");
        $stmt->execute([$hashed_password, $user['id']]);
        
        return true;
    } catch (PDOException $e) {
        error_log("Password reset error: " . $e->getMessage());
        return false;
    }
}
```

### Two-Factor Authentication (2FA)

#### 2FA Database Schema

```sql
CREATE TABLE user_2fa (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    secret_key VARCHAR(255) NOT NULL,
    is_enabled BOOLEAN DEFAULT FALSE,
    backup_codes JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user (user_id)
);
```

#### 2FA Implementation (requires Google Authenticator library)

```php
// Note: This requires a TOTP library like "pragmarx/google2fa"
// Install with: composer require pragmarx/google2fa

use PragmaRX\Google2FA\Google2FA;

class TwoFactorAuth {
    private $google2fa;
    
    public function __construct() {
        $this->google2fa = new Google2FA();
    }
    
    public function generateSecret() {
        return $this->google2fa->generateSecretKey();
    }
    
    public function getQRCodeUrl($user_email, $secret) {
        return $this->google2fa->getQRCodeUrl(
            'Your App Name',
            $user_email,
            $secret
        );
    }
    
    public function verifyCode($secret, $code) {
        return $this->google2fa->verifyKey($secret, $code);
    }
    
    public function enable2FA($user_id, $secret) {
        global $pdo;
        
        try {
            // Generate backup codes
            $backup_codes = [];
            for ($i = 0; $i < 10; $i++) {
                $backup_codes[] = strtoupper(bin2hex(random_bytes(4)));
            }
            
            $stmt = $pdo->prepare("
                INSERT INTO user_2fa (user_id, secret_key, is_enabled, backup_codes) 
                VALUES (?, ?, 1, ?) 
                ON DUPLICATE KEY UPDATE 
                secret_key = ?, is_enabled = 1, backup_codes = ?
            ");
            
            $backup_codes_json = json_encode($backup_codes);
            $stmt->execute([$user_id, $secret, $backup_codes_json, $secret, $backup_codes_json]);
            
            return $backup_codes;
        } catch (PDOException $e) {
            error_log("2FA enable error: " . $e->getMessage());
            return false;
        }
    }
    
    public function is2FAEnabled($user_id) {
        global $pdo;
        
        try {
            $stmt = $pdo->prepare("SELECT is_enabled FROM user_2fa WHERE user_id = ?");
            $stmt->execute([$user_id]);
            $result = $stmt->fetch();
            
            return $result && $result['is_enabled'];
        } catch (PDOException $e) {
            error_log("2FA check error: " . $e->getMessage());
            return false;
        }
    }
}
```

### Social Login Integration

#### OAuth Helper Class (basic structure)

```php
class SocialLogin {
    
    public static function getGoogleAuthUrl() {
        $client_id = 'your_google_client_id';
        $redirect_uri = 'https://yoursite.com/auth/google/callback';
        $scope = 'openid email profile';
        
        $params = [
            'client_id' => $client_id,
            'redirect_uri' => $redirect_uri,
            'scope' => $scope,
            'response_type' => 'code',
            'access_type' => 'offline'
        ];
        
        return 'https://accounts.google.com/o/oauth2/auth?' . http_build_query($params);
    }
    
    public static function handleGoogleCallback($code) {
        // Exchange code for access token
        $token_url = 'https://oauth2.googleapis.com/token';
        $token_data = [
            'client_id' => 'your_google_client_id',
            'client_secret' => 'your_google_client_secret',
            'redirect_uri' => 'https://yoursite.com/auth/google/callback',
            'grant_type' => 'authorization_code',
            'code' => $code
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $token_url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($token_data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        
        $response = curl_exec($ch);
        curl_close($ch);
        
        $token_info = json_decode($response, true);
        
        if (isset($token_info['access_token'])) {
            // Get user info
            $user_info_url = 'https://www.googleapis.com/oauth2/v2/userinfo?access_token=' . $token_info['access_token'];
            $user_info = json_decode(file_get_contents($user_info_url), true);
            
            return self::processGoogleUser($user_info);
        }
        
        return false;
    }
    
    private static function processGoogleUser($user_info) {
        global $pdo;
        
        try {
            // Check if user exists
            $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
            $stmt->execute([$user_info['email']]);
            $existing_user = $stmt->fetch();
            
            if ($existing_user) {
                // Login existing user
                self::loginUser($existing_user);
                return true;
            } else {
                // Create new user
                $stmt = $pdo->prepare("
                    INSERT INTO users (first_name, last_name, email, username, password, email_verified) 
                    VALUES (?, ?, ?, ?, ?, 1)
                ");
                
                $username = self::generateUniqueUsername($user_info['given_name'] . $user_info['family_name']);
                $dummy_password = password_hash(bin2hex(random_bytes(32)), PASSWORD_DEFAULT);
                
                $stmt->execute([
                    $user_info['given_name'],
                    $user_info['family_name'],
                    $user_info['email'],
                    $username,
                    $dummy_password
                ]);
                
                $user_id = $pdo->lastInsertId();
                
                // Login new user
                $new_user = [
                    'id' => $user_id,
                    'username' => $username,
                    'email' => $user_info['email'],
                    'first_name' => $user_info['given_name'],
                    'last_name' => $user_info['family_name']
                ];
                
                self::loginUser($new_user);
                return true;
            }
        } catch (PDOException $e) {
            error_log("Social login error: " . $e->getMessage());
            return false;
        }
    }
    
    private static function loginUser($user) {
        session_regenerate_id(true);
        
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['email'] = $user['email'];
        $_SESSION['first_name'] = $user['first_name'];
        $_SESSION['last_name'] = $user['last_name'];
        $_SESSION['logged_in'] = true;
        $_SESSION['login_time'] = time();
    }
    
    private static function generateUniqueUsername($base) {
        global $pdo;
        
        $username = strtolower(preg_replace('/[^a-zA-Z0-9]/', '', $base));
        $counter = 1;
        $original_username = $username;
        
        while (true) {
            $stmt = $pdo->prepare("SELECT id FROM users WHERE username = ?");
            $stmt->execute([$username]);
            
            if (!$stmt->fetch()) {
                return $username;
            }
            
            $username = $original_username . $counter;
            $counter++;
        }
    }
}
```

### Account Security Features

#### Login History Tracking

```sql
CREATE TABLE login_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    login_successful BOOLEAN DEFAULT TRUE,
    location VARCHAR(100),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_login_time (login_time)
);
```

#### Security Monitoring Functions

```php
function log_login_attempt($user_id, $successful = true) {
    global $pdo;
    
    $ip_address = $_SERVER['REMOTE_ADDR'];
    $user_agent = $_SERVER['HTTP_USER_AGENT'] ?? '';
    $location = get_location_from_ip($ip_address); // Implement using IP geolocation service
    
    try {
        $stmt = $pdo->prepare("
            INSERT INTO login_history (user_id, ip_address, user_agent, login_successful, location) 
            VALUES (?, ?, ?, ?, ?)
        ");
        $stmt->execute([$user_id, $ip_address, $user_agent, $successful, $location]);
    } catch (PDOException $e) {
        error_log("Login logging error: " . $e->getMessage());
    }
}

function detect_suspicious_activity($user_id) {
    global $pdo;
    
    try {
        // Check for multiple failed attempts
        $stmt = $pdo->prepare("
            SELECT COUNT(*) as failed_count 
            FROM login_history 
            WHERE user_id = ? AND login_successful = 0 AND login_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)
        ");
        $stmt->execute([$user_id]);
        $failed_attempts = $stmt->fetch()['failed_count'];
        
        // Check for logins from new locations
        $stmt = $pdo->prepare("
            SELECT DISTINCT location 
            FROM login_history 
            WHERE user_id = ? AND login_successful = 1 AND login_time > DATE_SUB(NOW(), INTERVAL 24 HOUR)
        ");
        $stmt->execute([$user_id]);
        $recent_locations = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        $alerts = [];
        
        if ($failed_attempts >= 3) {
            $alerts[] = "Multiple failed login attempts detected";
        }
        
        if (count($recent_locations) > 2) {
            $alerts[] = "Logins from multiple locations detected";
        }
        
        return $alerts;
    } catch (PDOException $e) {
        error_log("Security monitoring error: " . $e->getMessage());
        return [];
    }
}
```

### Best Practices Summary

1. **Always use HTTPS** in production environments
2. **Hash passwords** using PHP's `password_hash()` function
3. **Validate and sanitize** all user input
4. **Implement rate limiting** to prevent brute force attacks
5. **Use CSRF tokens** to prevent cross-site request forgery
6. **Regenerate session IDs** after login/logout
7. **Implement proper error handling** without revealing sensitive information
8. **Use prepared statements** to prevent SQL injection
9. **Log security events** for monitoring and analysis
10. **Keep software updated** and follow security best practices
11. **Implement account lockout** after multiple failed attempts
12. **Use secure session configuration** (httponly, secure, samesite)
13. **Validate email addresses** before allowing login
14. **Implement proper logout** functionality
15. **Consider implementing 2FA** for enhanced security

This comprehensive guide covers all aspects of creating secure registration and login systems with PHP, from basic implementation to advanced security features. Remember to always test your implementation thoroughly and keep security as a top priority.