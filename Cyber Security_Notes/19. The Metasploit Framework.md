![metasploit framework overview in HTB academy](https://www.hackthebox.com/storage/blog/Db5t07KcdVhwla8YDxSbTs8HBY1zMbrg.png)

The Metasploit Project is a Ruby-based, modular penetration testing platform that allows you to write, test, and execute exploit code. This exploit code can be custom-made by you, or taken from a database containing the latest discovered and modularized exploits. 

At its core, the Metasploit Project is a collection of commonly used tools that provide a complete environment for penetration testing and exploit development. The Metasploit Framework includes a suite of tools that you can use to test security vulnerabilities, enumerate networks, execute attacks, and evade detection. 

### Understanding the Metasploit Framework

The Metasploit Framework Console (msfconsole) is the most popular interface to the Metasploit Framework (MSF). It provides an "all-in-one" centralized console and allows you to access virtually all options available in the MSF. 

![metasploit console commands cheatsheet](https://www.hackthebox.com/storage/blog/4RplhcjHHMMyjbGzog8UYNIHXzDfY10R.png)

---
## Metasploit uses and benefits

Using MSF has the following benefits: 

- **Open source:** many adopt the MSF because it’s open source and actively developed. This deep customization gives pentesters access to the source code and the ability to add their own modules.
- **Ease of use:** easily switch between payloads, this provides great flexibility when attempting to penetrate systems.
- **Clean exits:** MSF is able to exit cleanly without being detected, even if the target system is not expected to restart after the pentest.
- **Visual GUI:** manage vulnerabilities and create workspaces at a button's click.

## MSF Components

The Metasploit framework has several components that work together to offer a comprehensive penetration testing platform. 

![anatomy of metasploit framework](https://www.hackthebox.com/storage/blog/YnHEQmhMyFQOFq6EfH5B4xV1NO5d7YPL.jpg)

### Modules

Metasploit modules are prepared scripts with a specific purpose and functions that have already been developed and tested in the wild. Modules are organized into a variety of types, including Auxiliary, Exploits, and Payloads. 


![metasploit modules explained](https://www.hackthebox.com/storage/blog/RrYdoV7nYkaR9NdV6h263NRzMQ4SdGT5.jpg)

| **Type** | **Description** |
| --- | --- |
| Auxiliary | Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality. |
| Encoders | Ensure that payloads are intact to their destination. |
| Exploits | Defined as modules that exploit a vulnerability that will allow for the payload delivery. |
| NOP | (No Operation code) Keep the payload sizes consistent across exploit attempts. |
| Payloads | Code runs remotely and calls back to the attacker machine to establish a connection (or shell). |
| Plugins | Additional scripts can be integrated within an assessment with msfconsole and coexist. |
| Post | Wide array of modules to gather information, pivot deeper, etc. |

Metasploit also offers a well-developed search function for the existing modules. We can use this function to quickly search through all the modules using specific tags to find a suitable one for our target.

```bash
msf6 > help search
```

### Targets

Each module has a list of Targets, which are the unique Operating Systems (OS) that the module has been tested to run on. Use the “show targets” command within an exploit module view to display all available vulnerable targets for that specific exploit. 

Check whether the module supports automatic targeting, because it will default to the target listed in the 0 position unless instructed otherwise.

```aspnet
msf6 > show targets
```

### Payloads

A Metasploit Payload is a type of module that typically aids in returning a shell to the attacker. 

These payloads are sent with the exploit, and designed to bypass standard functioning procedures of the vulnerable service and then run on the target OS to attempt to return a reverse connection to the attacker and establish a foothold.

There are three types of payload modules in the Metasploit Framework: 

1. **Singles:** contain the exploit and the entire shellcode for the selected task. These payloads are by design more stable than their counterparts because they contain everything all-in-one.
2. **Stagers:** works with Stage payloads to perform a specific task. After deployment, a Stager establishes a connection between the attacker’s machine and the victim host, so that it can run stages on the remote host.
3. **Stages:** components that are downloaded by Stager payload modules. The various payload Stages provide advanced features with no size limits, such as Meterpreter, VNC Injection, and others.

### Encoders

Encoders assist with making payloads compatible with different processor architectures while at the same time helping with antivirus evasion. Encoders come into play when changing the payload to run on different OS and architectures.

### Databases

Databases in msfconsole keep track of your results. During complex machine assessments, things can get complicated due to the sheer amount of search results, entry points, detected issues, and discovered credentials, among other returned data. This is where Databases come into play. 

Msfconsole has built-in support for the PostgreSQL database system. With it, we have direct, quick, and easy access to scan results with the added ability to import and export results in conjunction with third-party tools. Database entries can also be used to configure Exploit module parameters directly with the already existing findings.

### Plugins

Plugins are readily available software that has already been released by third parties and have approval from the creators of Metasploit to integrate their software inside the framework. 

These can represent commercial products that have a Community Edition for free use but with limited functionality, or they can be individual projects developed by individuals.

The use of plugins makes a pentester's life even easier, bringing the functionality of other well-known software into the msfconsole or Metasploit Pro environments. 



## How to use Metasploit 

##### Step 1: Download and install Metasploit 

The Metasploit Framework works on several different platforms including Windows, Kali Linux, and macOS. Many security-oriented Linux distributions such as Parrot Security and Kali Linux come with msfconsole preinstalled.

##### Step 2: Launch Metasploit

Once installed, type msfconsole in your terminal of choice. After launching the msfconsole, the console presents the MSF splash art and the command line prompt, waiting for our first command.

##### Step 3: Update the database 

Metasploit benefits from a huge database of exploits and vulnerabilities. To benefit from this database, keeping it up-to-date must be a priority. Type the “db update” command to ensure you have the latest database version.

##### Step 4: Select your module

As discussed earlier, modules make up the core components of the Metasploit Framework. To browse modules for scanning or exploiting networks, locate modules in the following directory: 

`/path/to/metasploit/apps/pro/msf3/modules`

To find a specific exploit, use the “search” command. For instance, to find an exploit that targets the “SMB” protocol, type “search smb”.

Once you have the exploit you’re looking for, use the “use” command to select it. For instance, to run the `eternalromance` exploit, type `use exploit/windows/smb/MS17-010_eternalromance`.

##### Step 5: Set the target

Enter the IP address of the target system you want to test. Set the target with the “set” command. For instance, if the host’s IP address is 192.168.1.100, type “set RHOST 192.168.1.100.”

Don’t forget to check whether your module is compatible with your target system using the “show targets” command.



## Metasploit best practices for penetration testers 

As penetration testers, we should never rely solely on a tool to do our jobs for us, which is why these best practices should always be top of mind:

##### 1\. Don’t neglect your practical skills

Many people often think that the failure of an exploit disproves the existence of the suspected vulnerability. 

However, this is only proof that the Metasploit exploit you used did not work, not that the vulnerability does not exist. This is because many exploits may require customization for the target hosts to make the exploit work.

Therefore, consider automated tools such as the Metasploit framework as support tools, rather than a substitute for our manual skills.

##### 2\. Understand the fundamentals

Before executing any form of exploit, we must understand the fundamentals of penetration testing. This is not only key to excelling in your work, but also to spotting things that tools can overlook. 

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdXH1ZrdMDbsJzmOW1X4CZBphF7Ju3AwfocC14JLxqm3_4Nhekw4cKnE8q3d5p_XTkYrAN9L2fSIEupGq9tcEwLsW7TfOTKcWxwJxiBT0sdKGRN59iwTrchul8HKcoioMXDl39M4xMu-JmWZ0VbYZmGbFto?key=Y63YXwwagNibOJ6F2cQ1Kw)

You should learn how to manually perform exploits before using tools. When beginners get into the testing side of security, they usually default to a linear, tool-based problem-solving workflow. 

However, real-world penetration testing requires an element of raw human intuition. If human intuition wasn’t needed, then paid software would have solved security by now. You can’t rely exclusively on programmatic or tool-oriented thinking because creativity, adaptability, and out-of-the-box thinking are critical.

##### 3\. Keep Metasploit up-to-date 

MSF is constantly being patched and updated, including updates for the latest CVEs. This means that you must keep it updated to make the most out of the tool, and to avoid overlooking recent vulnerabilities. 

We recommend checking for updates with the `db update` command every time you use it. 

Remember to check the **Metasploit documentation** if you have issues.

##### 4\. Keep track of your progress

You can become a better penetration tester by making notes on your findings throughout the process. This will help you spot areas for improvement, and prove your value to key stakeholders. 

Don’t forget to take screenshots whenever you run an exploit or achieve access to something. They say “pictures are worth a thousand words”, and these screenshots can help you write any reports you have to produce. 


## Key Metasploit Concepts and Features

### Auxiliaries

In addition to the exploits and payloads, Metasploit provides auxiliaries, which are pre-configured modules to ease the work.

For example, the command  `use auxiliary/scanner/ftp/easy_file_sharing_ftp`

allows you to exploit a directory traversal vulnerability found in Easy File Sharing FTP Server 3.6. And scanners use a simple _run_ command to efficiently spot vulnerabilities to exploit.

In addition, auxiliaries are relatively organized with the use of categories (subfolders), which can be useful to help speed up work processes.

### Encoders

Encoders allow obfuscating your payloads to evade detection. For example, the command

`use encoder/x64/xor_ uses an 8-byte key` and takes advantage of x64 relative addressing.

### Evasion

Once you have generated your first payloads, there are more advanced settings you might appreciate, such as the evasion options, which can be found with the command _show evasion_.

It’s not always set by default for all payloads, but, if there are evasions available, you can use them to evade typical detection mechanisms, such as antivirus software, endpoint detection and response (EDR) software, or firewalls.

### nops

Nops are another type of modules provided by Metasploit. They can be shown with the command `use nop/tty/generic`.

These generators produce “a series of random bytes that you can use to bypass standard IDS and IPS NOP sled signatures.”

### Post-exploitation

Metasploit can help with post modules to escalate root privileges, install keyloggers, or execute PowerShell scripts after you have gained unauthorized access.

Such post-exploitation techniques are extremely useful to speed up operations during a pen test. For example, `use post/osx/capture/keylog_recorder` can be used to record keystrokes and other keyboard events.

### Grep

When you search for exploits or other modules, use _grep_ to speed up the process and select only the relevant results. It is a useful command for all types of modules, not just auxiliary scanners. Use grep along with the search command. For example:

`grep scanner search ssh`

### Meterpreter

Meterpreter is an advanced payload that is one of the most widely used payloads for Metasploit. It is often used in development to emulate attacks, and it has special features that allow migrating to another process or taking screenshots inside the target machine.

### Msfvenom

Msfvenom is the combination of payload generation and encoding that replaced **msfpayload** and **msfencode** in 2015. The syntax is not that complicated, and you can use it directly in Kali Linux by typing the command or just `msfpc` in the terminal (outside the msf console). Moreover, it’s not limited to one output format (e.i., you can generate .exe and other file types).

----

# PRACTICAL SESSION

