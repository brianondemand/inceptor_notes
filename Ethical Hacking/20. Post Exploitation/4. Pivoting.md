
Pivoting is **the act of using a compromised system to spread between different computer systems once inside the network, simulating the behavior of a real attacker**. This compromised machine is sometimes referred to as the “instance,” “plant,” or “foothold.”

![Diagram from kentosec.com](https://kentosec.files.wordpress.com/2022/01/pivoting2.png)

This can be broken down as follows.

- Stage 1 – Access and compromise the remotely accessible server (blue).
- Stage 2 – Pivot into the 172.168.1.0/24 subnet and compromise 172.168.1.22 (red).
- Stage 3 – Pivot into the 172.16.2.0/24 subnet and compromise 172.168.2.8 (green).
## **When should i Pivot ?**

After successful **foothold** to the target, by running `ip a` in your terminal, you should see two interfaces

![](https://i.imgur.com/CcWlRrc.png)

## **Method 1: Pivot with SSH & ProxyChains**

This method leverages SSH with dynamic port forwarding to create a socks proxy, with proxychains to help with tools that can't use socks proxies. You can leverage this tunnel two ways:

### **Description**

- In a tool, configure a SOCKS proxy and point it to the SSH tunnel. This works great in tools that support it like Burp.
- Run a command with proxychains, which tunnels data over the SSH proxy.

This method allows mostly complete access to the target network, with few limitations, and is generally my preferred way to access gated networks. It requires the following pre-conditions to leverage:

- Access on target machine
- SSH service running on target machine and reachable from the attacker machine.
- A password compromise or writing of a public key for entry, to a user that allows remote SSH login.

Non-root accounts may limit some tools from working fully (such as nmap), when creating certain types of packets are root only activities.

### **Setting up the tunnel**

First login with SSH using dynamic port forwarding. Assuming you are using the sample environment:

```bash
# -f : background SSH session
# -N : for portforwarding
# -D : port to bind to
# ssh -D localhost:<local_proxy_port> -f -N <user>@<Main machine IP>

$ ssh -D localhost:9000 -f -N root@10.10.155.5 -p 20022
```

This sets up  an SSH tunnel in the background on local port 9000.

### Setup ProxyChains

In `/etc/proxychains4.conf` (or similar depending on version), add the following to the end of the file:

```conf
socks5 127.0.0.1 9000
```

### Run Commands

Here is an nmap scan of the IP we want to access. You could use any normal ip range on the target network instead.

```bash
$ proxychains nmap -sV 10.10.10.5

Nmap scan report for webgoat (224.0.0.1)
Host is up (0.00027s latency).
rDNS record for 224.0.0.1: all-systems.mcast.net
Not shown: 998 closed ports
PORT     STATE SERVICE    VERSION
8080/tcp open  http-proxy
9001/tcp open  jdbc       HSQLDB JDBC (Network Compatibility Version 2.3.4.0)
```

**Note :** we can now run any command, but make sure to include the `proxychains` command first

## **Method 2: sshuttle** 

```bash
# Transparent proxy over SSH  
# Forwarding traffic through the pivot 
# It will then auto create necessary iptables rules
# sshuttle -r user@main_machine machine_to_pivot/24

$ sshuttle -r root@10.10.155.5 10.10.10.0/24

# Run SSH commands

$ sshuttle -r root@10.10.155.5 10.10.10.0/24 --ssh-cmd "ssh -i id_rsa"
```


#### **Reference**

https://cheatsheet.haax.fr/network/pivot_techniques/

